name: Enrich and Verify (Single Run)

on:
  workflow_dispatch:
    inputs:
      input:
        description: 'Path to input CSV (default: high_confidence_pi_mt_firms.csv)'
        required: false
        default: 'high_confidence_pi_mt_firms.csv'
      target:
        description: 'Number of verified emails to stop at (optional)'
        required: false
        default: ''
      concurrency:
        description: 'Total async concurrency (HTTP scrapes + DNS/SMTP checks)'
        required: false
        default: '50'
      http_timeout:
        description: 'HTTP page fetch timeout (seconds)'
        required: false
        default: '6'
      mx_timeout:
        description: 'DNS MX/SMTP check timeout (seconds)'
        required: false
        default: '3'

jobs:
  enrich_single:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Use lxml for speed if it's in your requirements.txt
          pip install -r requirements.txt

      - name: Run full enrichment
        env:
          INPUT: ${{ github.event.inputs.input }}
          TARGET: ${{ github.event.inputs.target }}
          CONCURRENCY: ${{ github.event.inputs.concurrency }}
          HTTP_TIMEOUT: ${{ github.event.inputs.http_timeout }}
          MX_TIMEOUT: ${{ github.event.inputs.mx_timeout }}
        run: |
          TARGET_ARG=""
          if [ -n "${TARGET}" ]; then
            TARGET_ARG="--target ${TARGET}"
          fi

          python3 enrich.py \
            --input "${INPUT}" \
            --output "enriched_verified_final.csv" \
            --sample "sample_top100_final.csv" \
            $TARGET_ARG \
            --concurrency "${CONCURRENCY}" \
            --http-timeout "${HTTP_TIMEOUT}" \
            --mx-timeout "${MX_TIMEOUT}"

      - name: Upload enriched CSV
        uses: actions/upload-artifact@v4
        with:
          name: enriched-verified-final
          path: enriched_verified_final.csv

      - name: Upload sample artifact
        uses: actions/upload-artifact@v4
        with:
          name: sample-top100-final
          path: sample_top100_final.csv
