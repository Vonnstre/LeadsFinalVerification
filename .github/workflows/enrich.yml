name: Enrich and Verify (Stop at target)

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Number of verified emails to stop at'
        required: false
        default: '10000'
      concurrency:
        description: 'HTTP concurrency for scraper'
        required: false
        default: '40'
      http_timeout:
        description: 'HTTP page fetch timeout (seconds)'
        required: false
        default: '8'
      mx_timeout:
        description: 'MX DNS check timeout (seconds)'
        required: false
        default: '4'

jobs:
  enrich:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # 4 hours
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      - name: Run enrichment (reads filtered_companies.csv from repo root)
        env:
          TARGET: ${{ github.event.inputs.target }}
          CONCURRENCY: ${{ github.event.inputs.concurrency }}
          HTTP_TIMEOUT: ${{ github.event.inputs.http_timeout }}
          MX_TIMEOUT: ${{ github.event.inputs.mx_timeout }}
        run: |
          echo "Running enrichment: target=$TARGET concurrency=$CONCURRENCY http_timeout=$HTTP_TIMEOUT mx_timeout=$MX_TIMEOUT"
          python3 scripts/enrich.py \
            --input filtered_companies.csv \
            --output enriched_verified.csv \
            --target "${TARGET}" \
            --concurrency "${CONCURRENCY}" \
            --http-timeout "${HTTP_TIMEOUT}" \
            --mx-timeout "${MX_TIMEOUT}"

      - name: Ensure output file exists (avoid upload failure)
        run: |
          if [ ! -f enriched_verified.csv ]; then
            echo "NO_RESULTS" > enriched_verified.csv
          fi

      - name: Upload artifact (enriched_verified.csv)
        uses: actions/upload-artifact@v4
        with:
          name: enriched-verified
          path: enriched_verified.csv
